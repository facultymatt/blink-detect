#NB#

This currently only works in Firefox because of the requirement to use `let` (JS 1.7), and is very far from optimised.